<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ“æŸ±é«”æ°´å¡”é«”ç©èˆ‡é‡é‡è¨ˆç®—å™¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
        }
        .container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .left-panel, .right-panel {
            padding: 20px;
            border-radius: 8px;
            background-color: #ffffff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .left-panel {
            flex: 1; 
            max-width: 300px;
        }
        .right-panel {
            flex: 3; 
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="number"] {
            width: 90%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        #results-panel {
            padding: 20px;
            border-radius: 8px;
            background-color: #e9ecef;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .unit-selector {
            margin-top: 15px;
        }
        /* ç¢ºä¿ LaTeX å…¬å¼èƒ½æ­£ç¢ºé¡¯ç¤º */
        #volumeCalculationSteps .mjx-container {
            margin: 5px 0;
            display: block; /* è®“å…¬å¼ç¨ç«‹æˆè¡Œ */
            text-align: left;
            font-size: 1.1em;
        }
        #volumeCalculationSteps h4 {
            margin-top: 0;
            color: #333;
        }
    </style>
</head>
<body>

    <h1>ğŸ’§ åœ“æŸ±é«”æ°´å¡”é«”ç©èˆ‡é‡é‡è¨ˆç®—å™¨</h1>
    <div class="container">
        <div class="left-panel">
            <h2>åƒæ•¸è¼¸å…¥ (å–®ä½: cm)</h2>
            <div class="input-group">
                <label for="outerDiameter">å¤–å¾‘ (D):</label>
                <input type="number" id="outerDiameter" value="128" min="1" required>
            </div>
            <div class="input-group">
                <label for="thickness">æ°´å¡”åšåº¦ (t):</label>
                <input type="number" id="thickness" value="0.6" min="0" required>
            </div>
            <div class="input-group">
                <label for="length">æ°´å¡”é•·åº¦ (L):</label>
                <input type="number" id="length" value="220" min="1" required>
            </div>
            <div class="input-group">
                <label for="waterHeight">æ°´ä½é«˜åº¦ (h):</label>
                <input type="number" id="waterHeight" value="98" min="0" required>
            </div>
            <button onclick="calculateAndDraw()">è¨ˆç®—èˆ‡ç¹ªè£½</button>
        </div>

        <div class="right-panel">
            <canvas id="tankCanvas" width="650" height="350"></canvas>
        </div>
    </div>

    <div id="results-panel">
        <h2>ğŸ“Š é«”ç©èˆ‡é‡é‡è¨ˆç®—éç¨‹</h2>
        <div id="volumeCalculationSteps">è«‹è¼¸å…¥åƒæ•¸ä¸¦é»æ“Šè¨ˆç®—æŒ‰éˆ•ã€‚</div>
        
        <div class="unit-selector">
            <label for="volumeUnit">é«”ç©å–®ä½ï¼š</label>
            <select id="volumeUnit" onchange="updateResults()">
                <option value="cm3">ç«‹æ–¹å…¬åˆ† (cmÂ³)</option>
                <option value="m3">ç«‹æ–¹å…¬å°º (mÂ³)</option>
                <option value="L">å…¬å‡ (L)</option>
                <option value="kL">å…¬ç§‰ (kL)</option>
            </select>
            <p><strong>æ°´é«”ç© (V)ï¼š</strong> <span id="displayVolume">0</span></p>
        </div>
        
        <hr>

        <div class="unit-selector">
            <label for="weightUnit">é‡é‡å–®ä½ï¼š</label>
            <select id="weightUnit" onchange="updateResults()">
                <option value="g">å…¬å…‹ (g)</option>
                <option value="kg">å…¬æ–¤ (kg)</option>
                <option value="t">å…¬å™¸ (t)</option>
            </select>
            <p style="margin-top: 5px; font-size: 0.9em;">*å‡è¨­æ°´çš„å¯†åº¦ç´„ç‚º $1 \text{ g/cm}^3$ã€‚</p>
            <p><strong>æ°´é‡é‡ (W)ï¼š</strong> <span id="displayWeight">0</span></p>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸ç”¨æ–¼å„²å­˜è¨ˆç®—çµæœ (ä»¥ cmÂ³ ç‚ºåŸºæº–)
        let calculatedVolumeCm3 = 0;
        
        /**
         * è¨ˆç®—æ©«æ”¾åœ“æŸ±é«”å…§ç‰¹å®šé«˜åº¦æ°´çš„é«”ç©ã€‚
         */
        function calculateWaterVolume(R, h, L) {
            if (h < 0 || R <= 0 || L <= 0) return { volume: 0, steps: "è¼¸å…¥åƒæ•¸ç„¡æ•ˆæˆ–æ°´ä½ç‚ºé›¶ã€‚" };
            h = Math.min(h, 2 * R); 
            let volume = 0;
            let steps = "";
            const PI = Math.PI;

            if (h === 0) {
                volume = 0;
                steps = `<h4>è¨ˆç®—çµæœ:</h4><p>æ°´ä½é«˜åº¦ $h = 0$ï¼Œé«”ç© $V = 0 \text{ cmÂ³}$ã€‚</p>`;
            } else {
                
                let area = 0;
                let area_fixed = 0;
                let volume_fixed = 0;
                const R_fixed = R.toFixed(2);
                const h_fixed = h.toFixed(2);
                const L_fixed = L.toFixed(2);
                
                if (h === 2 * R) {
                    // æ»¿æ°´ç‹€æ…‹
                    area = PI * R * R;
                    volume = area * L;
                    area_fixed = area.toFixed(2);
                    volume_fixed = volume.toFixed(2);
                    
                    steps = `
                    <div style="background-color: #e6ffe6; padding: 10px; border: 1px solid #c0ffc0; border-radius: 5px;">
                        <h4>æ»¿æ°´ç‹€æ…‹ ($h=D'$):</h4>
                        <p>1. åœ“å½¢æˆªé¢ç© $A = \pi \cdot R^2 = \pi \cdot ${R_fixed}^2 \approx ${area_fixed} \text{ cm}^2$</p>
                        <p>2. é«”ç© $V = A \cdot L = ${area_fixed} \cdot ${L_fixed} \approx ${volume_fixed} \text{ cmÂ³}$</p>
                    </div>`;

                } else {
                    // å¼“å½¢é«”ç©è¨ˆç®—
                    const discriminant = 2 * R * h - h * h;
                    
                    if (discriminant >= 0) {
                        area = R * R * Math.acos((R - h) / R) - (R - h) * Math.sqrt(discriminant);
                        volume = area * L;
                        area_fixed = area.toFixed(2);
                        volume_fixed = volume.toFixed(2);
                    } 
                    
                    steps = `
                    <div style="background-color: #f0f8ff; padding: 10px; border: 1px solid #d0e8ff; border-radius: 5px;">
                        <h4>æ­¥é©Ÿä¸€ï¼šè¨ˆç®—å¼“å½¢æˆªé¢ç© ($A$)</h4>
                        <p>å¼“å½¢é¢ç©å…¬å¼ (é©ç”¨æ©«æ”¾åœ“æŸ±é«”):</p>
                        $$A = R^2 \\cdot \\arccos \\left(\\frac{R-h}{R}\\right) - (R-h) \\cdot \\sqrt{2Rh - h^2}$$
                        <p><strong>ä»£å…¥æ•¸å€¼:</strong></p>
                        <p>$$A = ${R_fixed}^2 \\cdot \\arccos \\left(\\frac{${R_fixed}-${h_fixed}}{${R_fixed}}\\right) - (${R_fixed}-${h_fixed}) \\cdot \\sqrt{2\\cdot${R_fixed}\\cdot${h_fixed} - ${h_fixed}^2}$$</p>
                        <p>$$\\Rightarrow A \\approx ${area_fixed} \\text{ cm}^2$$</p>
                    </div>
                    <div style="background-color: #e6ffe6; padding: 10px; border: 1px solid #c0ffc0; border-radius: 5px; margin-top: 10px;">
                        <h4>æ­¥é©ŸäºŒï¼šè¨ˆç®—æ°´é«”ç© ($V$)</h4>
                        <p>é«”ç©å…¬å¼: $V = A \\cdot L$</p>
                        <p><strong>ä»£å…¥æ•¸å€¼:</strong></p>
                        <p>$$V = ${area_fixed} \\cdot ${L_fixed} \\approx ${volume_fixed} \\text{ cmÂ³}$$</p>
                    </div>`;
                }

                
            }
            return { volume: volume, steps: steps };
        }
        
        /**
         * å–®ä½è½‰æ›å‡½æ•¸ (ä¿æŒä¸è®Š)
         */
        function convertVolume(volumeCm3, unit) {
            switch (unit) {
                case 'cm3': return volumeCm3;
                case 'm3': return volumeCm3 / 1000000;
                case 'L': return volumeCm3 / 1000;
                case 'kL': return volumeCm3 / 1000000;
                default: return volumeCm3;
            }
        }
        function convertWeight(volumeCm3, unit) {
            const weightGrams = volumeCm3 * 1;
            switch (unit) {
                case 'g': return weightGrams;
                case 'kg': return weightGrams / 1000;
                case 't': return weightGrams / 1000000;
                default: return weightGrams;
            }
        }
        
        /**
         * ç¹ªè£½æ°´å¡”å’Œæ°´ä½çš„è¦–è¦ºåŒ–åœ–å½¢ (å·¥ç¨‹åœ–é¢¨æ ¼ - ä¿æŒä¸è®Š)
         */
        function drawTank(D, L_cm, h) {
            const canvas = document.getElementById('tankCanvas');
            const ctx = canvas.getContext('2d');
            const W = canvas.width;
            const H = canvas.height;
            ctx.clearRect(0, 0, W, H);
            
            // --- ç¹ªåœ–æ¯”ä¾‹å°ºè¨­å®š ---
            const maxL_px = W * 0.7;
            const maxD_px = H * 0.6;
            
            const SCALE_FACTOR = Math.min(maxL_px / L_cm, maxD_px / D);

            const Radius_px = D / 2 * SCALE_FACTOR; 
            const Length_px = L_cm * SCALE_FACTOR; 
            const h_px = h * SCALE_FACTOR; 
            const R_out_px = Radius_px;

            const startX = (W - Length_px) / 2;
            const endX = startX + Length_px;
            const centerY = H - R_out_px - 80; 

            const tankTopY = centerY - R_out_px;
            const tankBottomY = centerY + R_out_px;

            // --- ç¹ªè£½æ”¯æ¶ ---
            const standHeight = 40; 
            const standY_top = tankBottomY;
            const standY_bottom = standY_top + standHeight;

            ctx.strokeStyle = '#000000'; 
            ctx.lineWidth = 3;
            ctx.lineJoin = 'round';
            
            ctx.beginPath();
            ctx.moveTo(startX, standY_bottom);
            ctx.lineTo(endX, standY_bottom);
            ctx.stroke();
            
            const supportX_left = startX + Length_px * 0.15;
            const supportX_right = endX - Length_px * 0.15;
            
            ctx.beginPath();
            ctx.moveTo(supportX_left, standY_top);
            ctx.lineTo(supportX_left, standY_bottom);
            ctx.moveTo(supportX_right, standY_top);
            ctx.lineTo(supportX_right, standY_bottom);
            ctx.stroke();

            // --- ç¹ªè£½æ°´å¡”æœ¬é«”æ¡†æ¶ ---
            ctx.strokeStyle = '#000000'; 
            ctx.lineWidth = 3;
            ctx.fillStyle = '#FFFFFF'; 

            ctx.beginPath();
            ctx.rect(startX, tankTopY, Length_px, 2 * R_out_px);
            ctx.stroke();

            ctx.beginPath();
            ctx.arc(startX, centerY, R_out_px, 0, 2 * Math.PI); 
            ctx.stroke();
            
            ctx.beginPath();
            ctx.arc(endX, centerY, R_out_px, 0, 2 * Math.PI); 
            ctx.stroke();
            
            const capRadius = R_out_px * 0.15;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(startX + Length_px / 2, tankTopY, capRadius, 0, 2 * Math.PI);
            ctx.stroke();
            
            // --- ç¹ªè£½æ°´ (æ°´è—è‰²å¡«å……) ---
            if (h_px > 0) {
                const waterLevelY = tankBottomY - h_px; 

                ctx.fillStyle = 'rgba(0, 191, 255, 0.7)'; 
                
                const d_px = R_out_px - h_px; 
                const halfChord = Math.sqrt(R_out_px * R_out_px - d_px * d_px); 
                
                // A. ç¹ªè£½ä¸­é–“çš„çŸ©å½¢æ°´é«”
                ctx.beginPath();
                ctx.rect(startX, waterLevelY, Length_px, h_px);
                ctx.fill();
                
                // B. ç¹ªè£½å…©ç«¯çš„å¼“å½¢æ°´é«” (åœ“å½¢æˆªé¢)
                const angle = Math.acos(d_px / R_out_px); 
                let startAngle = angle; 
                let endAngle = 2 * Math.PI - angle; 
                
                // å·¦ç«¯å¼“å½¢
                ctx.beginPath();
                ctx.moveTo(startX + halfChord, waterLevelY);
                ctx.arc(startX, centerY, R_out_px, startAngle, endAngle, false); 
                ctx.lineTo(startX - halfChord, waterLevelY);
                ctx.closePath();
                ctx.fill();
                
                // å³ç«¯å¼“å½¢
                ctx.beginPath();
                ctx.moveTo(endX + halfChord, waterLevelY);
                ctx.arc(endX, centerY, R_out_px, startAngle, endAngle, false);
                ctx.lineTo(endX - halfChord, waterLevelY);
                ctx.closePath();
                ctx.fill();

                // C. ç¹ªè£½æ°´é¢ç·š (å¼·èª¿)
                ctx.strokeStyle = '#000080';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(startX, waterLevelY);
                ctx.lineTo(endX, waterLevelY);
                ctx.stroke();
            }
            
            // --- ç¹ªè£½æ¨™è¨»ç·šå’Œå°ºå¯¸ ---
            ctx.fillStyle = '#333';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';

            // æ¨™ç¤ºé•·åº¦ L
            const textY_L = tankTopY - 20;
            ctx.fillText(`L = ${L_cm} cm`, startX + Length_px / 2, textY_L);
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(startX, textY_L - 5);
            ctx.lineTo(endX, textY_L - 5);
            ctx.stroke();

            // æ¨™ç¤ºå…§å¾‘ D' (åœ¨å³å´)
            ctx.textAlign = 'left';
            const textX_D = endX + 15;
            ctx.fillText(`D' = ${D.toFixed(1)} cm`, textX_D, centerY + 5);
            ctx.beginPath();
            ctx.moveTo(textX_D - 5, tankTopY);
            ctx.lineTo(textX_D - 5, tankBottomY);
            ctx.stroke();

            // æ¨™ç¤ºæ°´ä½é«˜åº¦ h (åœ¨å·¦å´)
            ctx.textAlign = 'right';
            const textX_h = startX - 10;
            const current_h = h > 0 ? h : 0; // é¿å… h=0 æ™‚æ–‡å­—ä½ç½®éŒ¯èª¤
            ctx.fillText(`h = ${current_h} cm`, textX_h, tankBottomY - h_px / 2 + 5);
            
            // è™›ç·šæ¨™ç¤º h
            ctx.strokeStyle = '#000080';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.setLineDash([5, 5]);
            ctx.moveTo(startX, tankBottomY);
            ctx.lineTo(startX, tankBottomY - h_px);
            ctx.stroke();
            ctx.setLineDash([]); 

        }
        
        /**
         * åŸ·è¡Œè¨ˆç®—ä¸¦æ›´æ–°ä»‹é¢ 
         */
        function calculateAndDraw() {
            const outerD = parseFloat(document.getElementById('outerDiameter').value);
            const thickness = parseFloat(document.getElementById('thickness').value);
            const L = parseFloat(document.getElementById('length').value);
            let h = parseFloat(document.getElementById('waterHeight').value);

            const innerD = outerD - 2 * thickness;
            const R = innerD / 2;
            
            if (R <= 0 || L <= 0) {
                alert("éŒ¯èª¤ï¼šå…§å¾‘å¿…é ˆå¤§æ–¼ 0ã€‚è«‹æª¢æŸ¥å¤–å¾‘å’Œåšåº¦ã€‚");
                return;
            }
            
            const maxH = innerD;
            if (h > maxH) {
                h = maxH;
                document.getElementById('waterHeight').value = h;
            }
            
            const result = calculateWaterVolume(R, h, L);
            calculatedVolumeCm3 = result.volume;

            // ------------------ é«”ç©è¨ˆç®—éç¨‹å„ªåŒ–è¼¸å‡º ------------------
            const preCalculationHtml = `
                <p><strong>è¼¸å…¥åƒæ•¸ï¼š</strong>å¤–å¾‘ $D = ${outerD} \text{ cm}$ï¼Œåšåº¦ $t = ${thickness} \text{ cm}$ï¼Œé•·åº¦ $L = ${L} \text{ cm}$ï¼Œæ°´ä½ $h = ${h} \text{ cm}$</p>
                <div style="background-color: #f9f9f9; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px;">
                    <h4>ğŸ“ å‰ç½®è¨ˆç®— (æ°´å¡”å…§éƒ¨å°ºå¯¸)</h4>
                    <p>å…§å¾‘ $D' = D - 2t = ${outerD} - 2 \\times ${thickness} = ${innerD} \text{ cm}$</p>
                    <p>å…§åŠå¾‘ $R = D'/2 = ${R} \text{ cm}$</p>
                </div>`;
                
            const resultsHtml = preCalculationHtml + result.steps;
            document.getElementById('volumeCalculationSteps').innerHTML = resultsHtml;
            // --------------------------------------------------------

            updateResults();
            drawTank(innerD, L, h); 
            
            MathJax.typesetPromise();
        }

        /**
         * æ ¹æ“šé¸å®šçš„å–®ä½æ›´æ–°é«”ç©å’Œé‡é‡çš„é¡¯ç¤ºå€¼ 
         */
        function updateResults() {
            const volumeUnit = document.getElementById('volumeUnit').value;
            const weightUnit = document.getElementById('weightUnit').value;

            const displayV = convertVolume(calculatedVolumeCm3, volumeUnit);
            document.getElementById('displayVolume').textContent = `${displayV.toFixed(3)} ${volumeUnit}`;

            const displayW = convertWeight(calculatedVolumeCm3, weightUnit);
            document.getElementById('displayWeight').textContent = `${displayW.toFixed(3)} ${weightUnit}`;
        }

        // é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
        window.onload = () => {
             // è¼‰å…¥ MathJax è…³æœ¬ç”¨æ–¼æ¸²æŸ“ LaTeX å…¬å¼
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
            script.async = true;
            document.head.appendChild(script);

            window.MathJax = {
                tex: {
                    inlineMath: [['$', '$'], ['\\(', '\\)']]
                },
                chtml: {
                    scale: 0.9 
                }
            };
            
            calculateAndDraw();
        };

    </script>
</body>
</html>